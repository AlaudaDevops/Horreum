# Horreum 启动指南

本文档详细说明 Horreum 性能测试平台的前后端启动流程。

## 目录

- [环境要求](#环境要求)
- [快速启动](#快速启动)
- [启动方式详解](#启动方式详解)
- [登录信息](#登录信息)
- [故障排查](#故障排查)

---

## 环境要求

### 必需环境

- **Java 17** - 运行 Quarkus 后端
  - macOS: `brew install openjdk@17`
  - Linux: 安装 OpenJDK 17
- **Apache Maven 3.8+** - 构建工具
- **Node.js 18+** - 运行前端（仅前后端分离模式）
- **PostgreSQL 13+** - 数据库
- **Docker/Podman** - 运行依赖服务（可选）

### 检查环境

```bash
# 检查 Java 版本
java -version
# 应显示 openjdk version "17.x.x"

# 检查 Maven 版本
mvn -version
# 应显示 Apache Maven 3.8.x 或更高

# 检查 Node.js 版本（前后端分离模式需要）
node -version
# 应显示 v18.x 或更高
```

---

## 快速启动

### 方式 1: 一键开发模式（推荐新手）

**适用场景**: 快速体验、本地开发、调试

```bash
# 第一次运行需要先构建
mvn clean install -DskipTests

# 启动开发服务器（前后端一体）
mvn quarkus:dev -pl 'horreum-backend'
```

或使用提供的脚本：

```bash
./run-horreum-dev.sh
```

**访问地址**: http://localhost:8080

**特点**:
- 自动启动 PostgreSQL 和 Artemis 容器（Dev Services）
- 集成前后端，一个命令完成
- 支持热重载（代码修改自动生效）
- 包含测试数据和默认用户

---

### 方式 2: 前后端分离启动（推荐开发者）

**适用场景**: 前端开发、前后端独立调试

#### 步骤 1: 启动后端（终端 1）

```bash
./start-backend-final.sh
```

或手动运行：

```bash
export JAVA_HOME=/opt/homebrew/Cellar/openjdk@17/17.0.17/libexec/openjdk.jdk/Contents/Home
export PATH="$JAVA_HOME/bin:$PATH"

mvn quarkus:dev -pl 'horreum-backend' \
  -Dquarkus.quinoa.enabled=false \
  -Dquarkus.test.continuous-testing=disabled
```

**后端地址**: http://localhost:8080

#### 步骤 2: 启动前端（终端 2）

```bash
./start-frontend-final.sh
```

或手动运行：

```bash
cd horreum-web
npm run dev
```

**前端地址**: http://localhost:3000

**特点**:
- 前端支持 Vite 快速热重载
- 前端自动代理后端 API
- 适合前端页面开发

---

### 方式 3: 生产模式启动

**适用场景**: 连接外部数据库、生产环境测试

```bash
# 先构建应用
mvn clean package -DskipTests

# 运行打包后的应用
./run-horreum.sh
```

或手动运行：

```bash
export JAVA_HOME=/opt/homebrew/Cellar/openjdk@17/17.0.17/libexec/openjdk.jdk/Contents/Home
export PATH="$JAVA_HOME/bin:$PATH"

cd horreum-backend
java -jar target/quarkus-app/quarkus-run.jar
```

**注意**: 需要在 `horreum-backend/` 目录下创建 `.env` 文件配置外部数据库：

```properties
# .env 文件示例
quarkus.datasource.jdbc.url=jdbc:postgresql://192.168.0.141:5432/horreum
quarkus.datasource.username=horreum
quarkus.datasource.password=your_password
horreum.amqp.host=192.168.0.141
horreum.amqp.port=5672
```

---

## 启动方式详解

### 构建项目

#### 完整构建（包含测试）

```bash
mvn clean install
```

**时间**: 约 10-20 分钟（包含所有测试）

#### 快速构建（跳过测试）

```bash
mvn clean install -DskipTests -DskipITs
```

**时间**: 约 3-5 分钟

#### 格式化代码

Horreum 强制执行代码格式规范：

```bash
# 自动格式化代码
mvn formatter:format impsort:sort

# 或在构建时自动格式化
mvn clean install -DskipTests
```

---

### 开发模式详解

#### 启动配置

开发模式使用 Quarkus Dev Services 自动启动依赖容器：

- **PostgreSQL**: 自动启动在随机端口
- **Artemis MQ**: 自动启动消息队列
- **Keycloak**: 认证服务（可禁用）

#### 禁用持续测试

如果不需要持续测试（节省资源）：

```bash
mvn quarkus:dev -pl 'horreum-backend' \
  -Dquarkus.test.continuous-testing=disabled
```

#### 使用 Podman 替代 Docker

```bash
# 终端 1: 启动 Podman socket
podman system service -t 0

# 终端 2: 设置环境变量
export DOCKER_HOST=unix:///run/user/$(id -u)/podman/podman.sock
mvn quarkus:dev -pl 'horreum-backend'
```

---

### 前端独立开发

前端基于 React + TypeScript + Vite：

```bash
cd horreum-web

# 安装依赖（首次运行）
npm install

# 启动开发服务器
npm run dev

# 构建生产版本
npm run build
```

**前端配置** (`horreum-web/vite.config.ts`):
- 开发端口: 3000
- API 代理: /api/* -> http://localhost:8080

---

## 登录信息

### 默认用户

| 角色 | 用户名 | 密码 | 说明 |
|------|--------|------|------|
| 超级管理员 | `horreum.bootstrap` | `secret` | 开发环境默认用户 |

### 访问地址

| 服务 | 地址 | 说明 |
|------|------|------|
| 应用首页 | http://localhost:8080 | 完整应用（开发模式） |
| 前端开发 | http://localhost:3000 | 前后端分离模式 |
| API 文档 | http://localhost:8080/q/swagger-ui | Swagger UI |
| 健康检查 | http://localhost:8080/q/health | 服务状态 |

### 创建新用户

使用提供的脚本创建额外管理员：

```bash
./create-admin-user.sh
```

按提示选择创建方式：
1. 通过 API 创建（推荐）
2. 通过数据库 SQL 创建

---

## 故障排查

### 1. 端口被占用

**问题**: 8080 或 3000 端口已被使用

```bash
# 查找占用进程
lsof -i :8080
lsof -i :3000

# 终止进程
kill -9 <PID>
```

### 2. Java 版本错误

**问题**: 显示 "UnsupportedClassVersionError" 或 Java 版本不是 17

```bash
# macOS: 设置 Java 17
export JAVA_HOME=/opt/homebrew/Cellar/openjdk@17/17.0.17/libexec/openjdk.jdk/Contents/Home
export PATH="$JAVA_HOME/bin:$PATH"

# 验证
java -version
```

### 3. Docker/Podman 服务未启动

**问题**: "Cannot connect to Docker daemon"

```bash
# Docker 桌面版: 确保 Docker Desktop 运行中

# Podman: 启动 Podman socket
podman system service -t 0

# 设置环境变量
export DOCKER_HOST=unix:///run/user/$(id -u)/podman/podman.sock
```

### 4. 构建失败 - 代码格式问题

**问题**: "There are test failures" 或格式检查失败

```bash
# 格式化所有代码
mvn formatter:format impsort:sort

# 重新构建
mvn clean install -DskipTests
```

### 5. 前端无法连接后端

**问题**: API 请求 404 或 CORS 错误

**解决方案**:
- 确保后端已在 8080 端口启动
- 检查 `horreum-web/vite.config.ts` 中的 proxy 配置
- 前端开发必须使用 3000 端口（不能直接访问 8080）

### 6. 数据库连接失败

**问题**: "Connection refused" 或数据库错误

**开发模式**: Quarkus 会自动启动 PostgreSQL 容器，确保 Docker/Podman 运行

**生产模式**: 检查 `.env` 文件中的数据库配置

```bash
# 测试数据库连接
psql -h 192.168.0.141 -p 5432 -U horreum -d horreum
```

### 7. 清理并重新构建

**最后手段**: 完全清理并重建

```bash
# 清理 Maven 缓存
mvn clean

# 清理 Node 模块（如果前端有问题）
cd horreum-web
rm -rf node_modules package-lock.json
npm install
cd ..

# 重新构建
mvn clean install -DskipTests
```

---

## 环境变量参考

### 后端配置文件

主配置: `horreum-backend/src/main/resources/application.properties`

环境覆盖: `horreum-backend/.env`

### 常用环境变量

```bash
# Java 环境
export JAVA_HOME=/path/to/java17
export PATH="$JAVA_HOME/bin:$PATH"

# Podman 支持
export DOCKER_HOST=unix:///run/user/$(id -u)/podman/podman.sock

# 数据库（生产模式）
export QUARKUS_DATASOURCE_JDBC_URL=jdbc:postgresql://host:port/db
export QUARKUS_DATASOURCE_USERNAME=user
export QUARKUS_DATASOURCE_PASSWORD=password
```

---

## 快速命令参考

```bash
# 开发模式（一体化）
mvn quarkus:dev -pl 'horreum-backend'

# 前后端分离 - 后端
mvn quarkus:dev -pl 'horreum-backend' -Dquarkus.quinoa.enabled=false

# 前后端分离 - 前端
cd horreum-web && npm run dev

# 构建（跳过测试）
mvn clean install -DskipTests

# 格式化代码
mvn formatter:format impsort:sort

# 运行特定测试
mvn test -Dtest=TestClassName

# 生产模式运行
java -jar horreum-backend/target/quarkus-app/quarkus-run.jar
```

---

## 下一步

- 访问 http://localhost:8080
- 使用 `horreum.bootstrap` / `secret` 登录
- 查看 [官方文档](https://horreum.hyperfoil.io) 了解更多功能
- 运行 `./infra-legacy/example-configuration.sh` 加载示例数据

---

**文档版本**: 1.0
**更新时间**: 2025-12-25
**适用版本**: Horreum 0.20-SNAPSHOT
